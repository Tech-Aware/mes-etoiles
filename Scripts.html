<script>
// ==================================================
// üåü MES √âTOILES - SCRIPTS v4 avec √âmotions
// ==================================================

let currentUser = null;
let userData = null;
let tasksConfig = null;

// T√¢ches
let allTasks = [];

const MAX_TASK_SCORE = 1;
const MIN_TASK_SCORE = -1;
const MAX_GESTION_SCORE = 1;
const MIN_GESTION_SCORE = -1;
let MAX_POINTS = 0;
let MIN_POINTS = 0;

const emotionSources = [
  { emoji: 'üè†', name: 'Maison' },
  { emoji: 'üè´', name: '√âcole' },
  { emoji: 'üë´', name: 'Copains' },
  { emoji: 'üë≠', name: 'S≈ìur' },
  { emoji: 'üë®‚Äçüë©‚Äçüëß', name: 'Parents' },
  { emoji: '‚öΩ', name: 'Activit√©' }
];

let taskRatings = {};
let selectedEmotions = [];
let selectedSourcesByEmotion = {};
let gestionScore = null;
let selectedHumeur = null;
let audioContext = null;

const audioConfig = {
  defaultVolume: 0.08,
  clickDuration: 0.08,
  sparkleDuration: 0.16
};

// ==================================================
// INITIALISATION
// ==================================================
document.addEventListener('DOMContentLoaded', function() {
  loadPersonnes();
  setupBoutonAudio();
  console.info('Initialisation termin√©e : audio et effets visuels pr√™ts.');
});

function setupBoutonAudio() {
  document.addEventListener('click', event => {
    const btn = event.target.closest('button');
    if (!btn) return;

    playButtonSound(btn);
    triggerButtonVisualEffect(btn, event);
  });
}

function loadTasksConfigForPerson(personne, callback) {
  console.info('Chargement de la configuration des t√¢ches depuis le Sheets.', { personne });
  google.script.run
    .withSuccessHandler(config => {
      applyTasksConfig(config);
      if (typeof callback === 'function') callback();
    })
    .withFailureHandler(error => {
      console.error('Impossible de charger la configuration des t√¢ches.', { personne, error });
      applyTasksConfig(getFallbackTasksConfig());
      if (typeof callback === 'function') callback();
    })
    .getTasksConfig(personne);
}

function applyTasksConfig(config) {
  if (!config || !Array.isArray(config.sections)) {
    console.error('Configuration des t√¢ches invalide.', config);
    config = getFallbackTasksConfig();
  }

  tasksConfig = config;
  allTasks = Array.isArray(config.taskIds) ? config.taskIds : [];
  MAX_POINTS = Number(config.maxPoints ?? 0);
  MIN_POINTS = Number(config.minPoints ?? 0);

  if (allTasks.length === 0) {
    console.warn('Aucune t√¢che active d√©tect√©e, utilisation du fallback.');
    tasksConfig = getFallbackTasksConfig();
    allTasks = tasksConfig.taskIds;
    MAX_POINTS = tasksConfig.maxPoints;
    MIN_POINTS = tasksConfig.minPoints;
  }

  renderTaskSections(tasksConfig.sections);
  updatePreviewMaxPoints();
  resetForm();
}

function renderTaskSections(sections) {
  const container = document.getElementById('tasks-sections');
  if (!container) {
    console.error('Conteneur des t√¢ches introuvable (#tasks-sections).');
    return;
  }

  if (!Array.isArray(sections) || sections.length === 0) {
    container.innerHTML = '<p class="tasks-empty">Aucune t√¢che active pour le moment.</p>';
    return;
  }

  container.innerHTML = sections.map(section => {
    const headerClass = getCategoryHeaderClass(section);
    const tasksHtml = (section.tasks || []).map(task => `
      <div class="task-card" data-task="${task.id}">
        <div class="task-visual"><div class="task-emoji">${task.emoji || '‚≠ê'}</div></div>
        <div class="task-info">
          <div class="task-name">${task.nom || 'T√¢che'}</div>
          <div class="task-desc">${task.description || ''}</div>
        </div>
        <div class="rating-scale">
          <button class="scale-btn" data-value="-1" onclick="setTaskRating('${task.id}', -1, this)"><span class="scale-emoji">üôÅ</span></button>
          <button class="scale-btn" data-value="0" onclick="setTaskRating('${task.id}', 0, this)"><span class="scale-emoji">üòê</span></button>
          <button class="scale-btn" data-value="1" onclick="setTaskRating('${task.id}', 1, this)"><span class="scale-emoji">üòä</span></button>
        </div>
      </div>
    `).join('');

    return `
      <div class="category-section">
        <div class="category-header ${headerClass}">
          <span class="category-icon">${section.emoji || '‚≠ê'}</span>
          <span class="category-title">${section.title || 'Mes t√¢ches'}</span>
        </div>
        <div class="tasks-list">
          ${tasksHtml}
        </div>
      </div>
    `;
  }).join('');
}

function getCategoryHeaderClass(section) {
  const type = (section?.type || section?.id || '').toLowerCase();
  if (type === 'corvees' || type === 'corv√©es') return 'corvees-bg';
  if (type === 'comportement') return 'comportement-bg';
  if (type === 'rituels') return 'rituels-bg';
  return 'default-bg';
}

function updatePreviewMaxPoints() {
  const maxElement = document.querySelector('.preview-max');
  if (maxElement) {
    maxElement.textContent = `/ ${MAX_POINTS}`;
  }
}

function getFallbackTasksConfig() {
  const fallbackSections = [
    {
      id: 'corvees',
      title: 'Mes petits travaux',
      emoji: 'üßπ',
      type: 'corvees',
      tasks: [
        { id: 'rangerChambre', nom: 'Ranger ma chambre', description: 'Mes affaires sont bien rang√©es', emoji: 'üõèÔ∏è' },
        { id: 'faireLit', nom: 'Faire mon lit', description: 'Ma couette est bien mise', emoji: 'üõå' },
        { id: 'rangerJouets', nom: 'Ranger mes jouets', description: 'Mes jouets sont √† leur place', emoji: 'üß∏' },
        { id: 'aiderTable', nom: 'Aider √† table', description: 'Mettre ou d√©barrasser', emoji: 'üçΩÔ∏è' }
      ]
    },
    {
      id: 'comportement',
      title: 'Mon comportement',
      emoji: 'üíõ',
      type: 'comportement',
      tasks: [
        { id: 'ecouter', nom: '√âcouter papa et maman', description: 'J\'√©coute quand on me parle', emoji: 'üëÇ' },
        { id: 'gentilSoeur', nom: 'Gentil avec ma s≈ìur', description: 'On joue bien ensemble', emoji: 'üë≠' },
        { id: 'politesse', nom: 'Les mots magiques', description: 'S\'il te pla√Æt, merci, pardon', emoji: 'üôè' },
        { id: 'pasColere', nom: 'Calme et zen', description: 'Pas de grosse col√®re', emoji: 'üòå' }
      ]
    },
    {
      id: 'rituels',
      title: 'Mes rituels',
      emoji: 'üåÖ',
      type: 'rituels',
      tasks: [
        { id: 'dentsMatin', nom: 'Brosser mes dents', description: 'Apr√®s le petit-d√©jeuner', emoji: 'ü¶∑' },
        { id: 'dentsSoir', nom: 'Brosser mes dents', description: 'Avant le dodo', emoji: 'ü¶∑' },
        { id: 'habiller', nom: 'M\'habiller tout seul', description: 'Comme un grand !', emoji: 'üëï' },
        { id: 'cartable', nom: 'Pr√©parer mes affaires', description: 'Mon sac est pr√™t', emoji: 'üéí' }
      ]
    }
  ];

  const taskIds = fallbackSections.flatMap(section => section.tasks.map(task => task.id));
  const maxPoints = taskIds.length * MAX_TASK_SCORE + MAX_GESTION_SCORE;
  const minPoints = taskIds.length * MIN_TASK_SCORE + MIN_GESTION_SCORE;

  return {
    sections: fallbackSections,
    taskIds,
    maxPoints,
    minPoints
  };
}

function ensureAudioContext() {
  if (audioContext) return audioContext;
  if (!window.AudioContext && !window.webkitAudioContext) {
    console.warn('AudioContext non support√© : sons d√©sactiv√©s.');
    return null;
  }

  try {
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
    console.info('AudioContext initialis√© pour les effets sonores.');
  } catch (error) {
    console.error('Impossible d\'initialiser AudioContext.', error);
    return null;
  }

  return audioContext;
}

function resumeAudioContext(context) {
  if (!context) return;
  if (context.state === 'suspended') {
    context.resume().catch(error => {
      console.error('√âchec de reprise AudioContext.', error);
    });
  }
}

function playButtonSound(btn) {
  const context = ensureAudioContext();
  if (!context) return;

  resumeAudioContext(context);

  const soundType = getButtonSoundType(btn);
  try {
    if (soundType === 'sparkle') {
      playSparkleSound(context);
      return;
    }

    if (soundType === 'rating') {
      playRatingSound(context, btn);
      return;
    }

    playClickSound(context, soundType);
  } catch (error) {
    console.error('Erreur lors de la lecture du son.', error);
  }
}

function triggerButtonVisualEffect(btn, event) {
  const soundType = getButtonSoundType(btn);
  try {
    const effect = document.createElement('span');
    const emoji = getVisualEmoji(btn, soundType);
    effect.className = `mini-video-effect mini-video-${soundType}`;
    effect.textContent = emoji;

    const rect = btn.getBoundingClientRect();
    const left = (event?.clientX ?? rect.left + rect.width / 2) - rect.left;
    const top = (event?.clientY ?? rect.top + rect.height / 2) - rect.top;

    effect.style.left = `${left}px`;
    effect.style.top = `${top}px`;

    btn.classList.add('btn-animable');
    btn.appendChild(effect);

    effect.addEventListener('animationend', () => effect.remove());
  } catch (error) {
    console.error('Erreur lors de l\'animation visuelle du bouton.', error);
  }
}

function getVisualEmoji(btn, soundType) {
  if (soundType === 'rating') {
    const emojiElement = btn.querySelector('.scale-emoji');
    if (emojiElement) return emojiElement.textContent.trim();
  }
  if (soundType === 'emotion') {
    const emotionFace = btn.querySelector('.emotion-face, .humeur-emoji');
    if (emotionFace) return emotionFace.textContent.trim();
  }
  if (soundType === 'reward') return 'üéÅ';
  if (soundType === 'nav') return '‚≠ê';
  if (soundType === 'sparkle') return '‚ú®';
  return 'üí´';
}

function getButtonSoundType(btn) {
  if (btn.id === 'btn-submit') return 'sparkle';
  if (btn.classList.contains('nav-btn') || btn.classList.contains('btn-home')) return 'nav';
  if (btn.classList.contains('scale-btn')) return 'rating';
  if (btn.classList.contains('emotion-btn') || btn.classList.contains('humeur-btn')) return 'emotion';
  if (btn.classList.contains('btn-reward')) return 'reward';
  return 'click';
}

function playClickSound(context, variant) {
  const baseFrequency = {
    click: 520,
    nav: 480,
    emotion: 600,
    reward: 640
  }[variant] || 520;

  const frequency = baseFrequency + Math.random() * 40;
  const duration = audioConfig.clickDuration;
  playTone(context, frequency, duration, 'triangle', audioConfig.defaultVolume);
}

function playRatingSound(context, btn) {
  const rating = Number(btn.dataset.value ?? 2);
  const taskKey = getTaskKeyFromRatingButton(btn);
  const taskBase = getTaskBaseFrequency(taskKey);
  const moodOffset = getMoodOffsetForRating(rating);
  const duration = audioConfig.clickDuration + 0.08;
  const frequency = taskBase + moodOffset;

  console.info('Lecture son d‚Äô√©valuation (graduation)', { taskKey, rating, frequency });

  if (rating <= 0) {
    playDisappointmentSound(context, frequency, duration);
    return;
  }

  if (rating === 1) {
    playNeutralSound(context, frequency, duration);
    return;
  }

  playHappySound(context, frequency, duration);
}

function getTaskKeyFromRatingButton(btn) {
  const card = btn.closest('.task-card');
  if (!card) return 'default';
  return card.dataset.task || 'default';
}

function getTaskBaseFrequency(taskKey) {
  const taskFrequencyMap = {
    rangerChambre: 360,
    faireLit: 380,
    rangerJouets: 410,
    aiderTable: 430,
    ecouter: 450,
    gentilSoeur: 470,
    politesse: 490,
    pasColere: 510,
    dentsMatin: 530,
    dentsSoir: 550,
    habiller: 570,
    cartable: 590,
    default: 520
  };

  if (!taskFrequencyMap[taskKey]) {
    console.warn('T√¢che inconnue pour le son d‚Äô√©valuation.', { taskKey });
  }

  return taskFrequencyMap[taskKey] ?? taskFrequencyMap.default;
}

function getMoodOffsetForRating(rating) {
  if (Number.isNaN(rating)) {
    console.warn('Note invalide pour le son d‚Äô√©valuation.', { rating });
    return 0;
  }

  const moodOffsets = [-200, 0, 180];
  return moodOffsets[Math.max(0, Math.min(rating, moodOffsets.length - 1))];
}

function playDisappointmentSound(context, baseFrequency, duration) {
  const lowFrequency = Math.max(120, baseFrequency - 180);
  playTone(context, lowFrequency, duration, 'sawtooth', audioConfig.defaultVolume * 0.9);
  playSlideTone(context, lowFrequency + 60, lowFrequency - 40, duration, 'square', audioConfig.defaultVolume * 0.5);
}

function playLowMoodSound(context, baseFrequency, duration) {
  const startFrequency = Math.max(160, baseFrequency - 120);
  playSlideTone(context, startFrequency + 30, startFrequency - 20, duration, 'triangle', audioConfig.defaultVolume * 0.6);
}

function playNeutralSound(context, baseFrequency, duration) {
  playTone(context, baseFrequency, duration, 'triangle', audioConfig.defaultVolume * 0.6);
}

function playHappySound(context, baseFrequency, duration) {
  playTone(context, baseFrequency, duration, 'sine', audioConfig.defaultVolume * 0.7);
  playTone(context, baseFrequency + 140, duration, 'sine', audioConfig.defaultVolume * 0.5);
  playSlideTone(context, baseFrequency + 60, baseFrequency + 120, duration, 'triangle', audioConfig.defaultVolume * 0.4);
}

function playSuperHappySound(context, baseFrequency, duration) {
  playTone(context, baseFrequency + 80, duration, 'sine', audioConfig.defaultVolume * 0.85);
  playTone(context, baseFrequency + 200, duration, 'sine', audioConfig.defaultVolume * 0.65);
  playTone(context, baseFrequency + 320, duration, 'sine', audioConfig.defaultVolume * 0.45);
  playSlideTone(context, baseFrequency + 120, baseFrequency + 260, duration, 'triangle', audioConfig.defaultVolume * 0.5);
}

function playSparkleSound(context) {
  const now = context.currentTime;
  playTone(context, 740, audioConfig.sparkleDuration, 'sine', audioConfig.defaultVolume, now);
  playTone(context, 940, audioConfig.sparkleDuration, 'sine', audioConfig.defaultVolume * 0.8, now + 0.05);
}

function playTone(context, frequency, duration, waveType, volume, startTime = context.currentTime) {
  const oscillator = context.createOscillator();
  const gainNode = context.createGain();

  oscillator.type = waveType;
  oscillator.frequency.setValueAtTime(frequency, startTime);

  gainNode.gain.setValueAtTime(0, startTime);
  gainNode.gain.linearRampToValueAtTime(volume, startTime + 0.02);
  gainNode.gain.exponentialRampToValueAtTime(0.001, startTime + duration);

  oscillator.connect(gainNode);
  gainNode.connect(context.destination);

  oscillator.start(startTime);
  oscillator.stop(startTime + duration + 0.02);
}

function playSlideTone(context, startFrequency, endFrequency, duration, waveType, volume, startTime = context.currentTime) {
  const oscillator = context.createOscillator();
  const gainNode = context.createGain();

  oscillator.type = waveType;
  oscillator.frequency.setValueAtTime(startFrequency, startTime);
  oscillator.frequency.exponentialRampToValueAtTime(Math.max(1, endFrequency), startTime + duration);

  gainNode.gain.setValueAtTime(0, startTime);
  gainNode.gain.linearRampToValueAtTime(volume, startTime + 0.02);
  gainNode.gain.exponentialRampToValueAtTime(0.001, startTime + duration);

  oscillator.connect(gainNode);
  gainNode.connect(context.destination);

  oscillator.start(startTime);
  oscillator.stop(startTime + duration + 0.02);
}

function resetForm() {
  taskRatings = {};
  allTasks.forEach(t => taskRatings[t] = null);
  selectedEmotions = [];
  selectedSourcesByEmotion = {};
  gestionScore = null;
  selectedHumeur = null;
}

// ==================================================
// CHARGEMENT DES PERSONNES
// ==================================================
function loadPersonnes() {
  google.script.run
    .withSuccessHandler(displayPersonnes)
    .withFailureHandler(handleError)
    .getPersonnes();
}

function displayPersonnes(personnes) {
  const container = document.getElementById('personnes-list');
  container.innerHTML = personnes.map(p => `
    <div class="personne-card" style="border-color: ${p.couleur}" onclick="selectPersonne('${p.nom}')">
      <span class="personne-avatar">${p.avatar}</span>
      <span class="personne-nom">${p.nom}</span>
    </div>
  `).join('');
}

// ==================================================
// S√âLECTION PERSONNE
// ==================================================
function selectPersonne(nom) {
  currentUser = nom;
  showToast('Chargement...', '');
  
  google.script.run
    .withSuccessHandler(onUserLoaded)
    .withFailureHandler(handleError)
    .getPersonneData(nom);
}

function onUserLoaded(data) {
  userData = data;
  
  document.getElementById('header-avatar').textContent = data.avatar;
  document.getElementById('header-name').textContent = data.nom;
  document.getElementById('header-points').textContent = data.weekPoints;
  
  document.getElementById('screen-home').classList.remove('active');
  document.getElementById('screen-main').classList.add('active');

  loadTasksConfigForPerson(data.nom, () => {
    if (data.evaluatedToday) {
      document.getElementById('eval-form').style.display = 'none';
      document.getElementById('already-done').style.display = 'block';
    } else {
      document.getElementById('eval-form').style.display = 'block';
      document.getElementById('already-done').style.display = 'none';
      resetForm();
      resetFormUI();
    }

    loadStatsPage();
    loadFamilyPage();
    loadRewardsPage();
    loadBadgesPage();

    hideToast();
  });
}

function resetFormUI() {
  document.querySelectorAll('.scale-btn').forEach(btn => btn.classList.remove('selected'));
  document.querySelectorAll('.emotion-btn').forEach(btn => btn.classList.remove('selected'));
  document.querySelectorAll('.source-btn').forEach(btn => btn.classList.remove('selected'));
  document.querySelectorAll('.gestion-btn').forEach(btn => btn.classList.remove('selected'));
  document.querySelectorAll('.humeur-btn').forEach(btn => btn.classList.remove('selected'));
  document.getElementById('selected-emotions').innerHTML = '';
  document.getElementById('sources-by-emotion').innerHTML = '';
  renderSourcesByEmotion();
  document.getElementById('preview-score').textContent = '0';
  document.getElementById('preview-fill').style.width = '0%';
  document.getElementById('preview-message').textContent = 'Remplis toutes les cases !';
  document.getElementById('btn-submit').disabled = true;
}

// ==================================================
// NAVIGATION
// ==================================================
function goHome() {
  document.getElementById('screen-main').classList.remove('active');
  document.getElementById('screen-home').classList.add('active');
  currentUser = null;
  userData = null;
  resetForm();
  
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  document.querySelector('.nav-btn[data-page="eval"]').classList.add('active');
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById('page-eval').classList.add('active');
}

function showPage(pageName) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  
  document.getElementById('page-' + pageName).classList.add('active');
  document.querySelector(`.nav-btn[data-page="${pageName}"]`).classList.add('active');
  
  if (pageName === 'family') loadFamilyPage();
  if (pageName === 'stats') loadStatsPage();
}

// ==================================================
// √âVALUATION - T√ÇCHES
// ==================================================
function setTaskRating(taskId, value, btn) {
  if (![MIN_TASK_SCORE, 0, MAX_TASK_SCORE].includes(value)) {
    console.warn('[setTaskRating] Valeur de t√¢che inattendue, s√©lection ignor√©e.', { taskId, value });
    return;
  }
  taskRatings[taskId] = value;
  
  const scale = btn.closest('.rating-scale');
  scale.querySelectorAll('.scale-btn').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
  
  updatePreview();
  checkCanSubmit();
}

// ==================================================
// √âVALUATION - √âMOTIONS
// ==================================================
function toggleEmotion(emoji, name, btn) {
  const index = selectedEmotions.findIndex(e => e.emoji === emoji);
  
  if (index > -1) {
    // Retirer
    selectedEmotions.splice(index, 1);
    delete selectedSourcesByEmotion[emoji];
    btn.classList.remove('selected');
  } else {
    // Ajouter (max 3)
    if (selectedEmotions.length < 3) {
      selectedEmotions.push({ emoji, name });
      btn.classList.add('selected');
    } else {
      showToast('Maximum 3 √©motions !', 'error');
      return;
    }
  }
  
  updateSelectedEmotionsDisplay();
  renderSourcesByEmotion();
  checkCanSubmit();
}

function updateSelectedEmotionsDisplay() {
  const container = document.getElementById('selected-emotions');
  
  if (selectedEmotions.length === 0) {
    container.innerHTML = '';
    return;
  }
  
  container.innerHTML = selectedEmotions.map(e => `
    <div class="selected-emotion-tag">
      <span>${e.emoji}</span>
      <span>${e.name}</span>
    </div>
  `).join('');
}

function renderSourcesByEmotion() {
  const container = document.getElementById('sources-by-emotion');

  if (selectedEmotions.length === 0) {
    container.innerHTML = '<p class="emotion-hint">Commence par choisir tes √©motions.</p>';
    return;
  }

  container.innerHTML = selectedEmotions.map(emotion => {
    const selectedSource = selectedSourcesByEmotion[emotion.emoji]?.emoji;
    const buttons = emotionSources.map(source => `
      <button class="source-btn ${selectedSource === source.emoji ? 'selected' : ''}"
              data-emotion="${emotion.emoji}"
              data-source="${source.emoji}"
              onclick="selectSourceForEmotion('${emotion.emoji}', '${source.emoji}', '${source.name}', this)">
        <span class="source-icon">${source.emoji}</span>
        <span class="source-name">${source.name}</span>
      </button>
    `).join('');

    return `
      <div class="source-emotion-block">
        <div class="source-emotion-title">${emotion.emoji} ${emotion.name}</div>
        <div class="sources-grid">${buttons}</div>
      </div>
    `;
  }).join('');
}

function selectSourceForEmotion(emotionEmoji, sourceEmoji, sourceName, btn) {
  const block = btn.closest('.source-emotion-block');
  if (!block) {
    console.warn('Bloc source introuvable pour la s√©lection.', { emotionEmoji, sourceEmoji });
    return;
  }

  block.querySelectorAll('.source-btn').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');

  selectedSourcesByEmotion[emotionEmoji] = { emoji: sourceEmoji, name: sourceName };
  console.info('Source s√©lectionn√©e pour √©motion.', { emotionEmoji, sourceEmoji, sourceName });
  checkCanSubmit();
}

function setGestion(value, btn) {
  if (![MIN_GESTION_SCORE, 0, MAX_GESTION_SCORE].includes(value)) {
    console.warn('[setGestion] Valeur de gestion inattendue, s√©lection ignor√©e.', { value });
    return;
  }
  document.querySelectorAll('.gestion-btn').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
  gestionScore = value;
  updatePreview();
  checkCanSubmit();
}

function setHumeur(emoji, btn) {
  if (!btn) {
    console.error('[setHumeur] Bouton de s√©lection introuvable pour l\'humeur.');
    return;
  }
  if (!emoji) {
    console.error('[setHumeur] Emoji d\'humeur manquant, s√©lection ignor√©e.');
    return;
  }
  document.querySelectorAll('.humeur-btn').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
  selectedHumeur = emoji;
  console.info(`[setHumeur] Humeur s√©lectionn√©e : ${emoji}`);
  checkCanSubmit();
}

// ==================================================
// PREVIEW & VALIDATION
// ==================================================
function updatePreview() {
  let total = 0;
  let filledTasks = 0;
  
  allTasks.forEach(t => {
    if (taskRatings[t] !== null) {
      total += taskRatings[t];
      filledTasks++;
    }
  });
  
  if (gestionScore !== null) {
    total += gestionScore;
  }
  
  document.getElementById('preview-score').textContent = total;
  const range = MAX_POINTS - MIN_POINTS || 1;
  const normalized = (total - MIN_POINTS) / range;
  const fillPercent = Math.max(0, Math.min(100, Math.round(normalized * 100)));
  document.getElementById('preview-fill').style.width = fillPercent + '%';
  
  const rawPercent = MAX_POINTS ? Math.round((total / MAX_POINTS) * 100) : 0;
  const percent = Math.max(0, Math.min(100, rawPercent));
  let message = '';
  
  if (filledTasks < allTasks.length) {
    message = `Encore ${allTasks.length - filledTasks} cases √† remplir !`;
  } else if (gestionScore === null) {
    message = 'N\'oublie pas les √©motions !';
  } else if (percent >= 90) {
    message = 'üåü INCROYABLE ! Tu es une STAR !';
  } else if (percent >= 75) {
    message = 'üéâ SUPER journ√©e !';
  } else if (percent >= 50) {
    message = 'üëç Bien jou√© !';
  } else {
    message = 'üí™ Tu peux faire mieux demain !';
  }
  
  document.getElementById('preview-message').textContent = message;
}

function checkCanSubmit() {
  const allTasksFilled = allTasks.every(t => taskRatings[t] !== null);
  const emotionsOk = selectedEmotions.length >= 1;
  const sourceOk = selectedEmotions.every(e => selectedSourcesByEmotion[e.emoji]);
  const gestionOk = gestionScore !== null;
  const humeurOk = selectedHumeur !== null;
  
  const canSubmit = allTasksFilled && emotionsOk && sourceOk && gestionOk && humeurOk;
  document.getElementById('btn-submit').disabled = !canSubmit;
}

// ==================================================
// SOUMETTRE √âVALUATION
// ==================================================
function submitEvaluation() {
  const btn = document.getElementById('btn-submit');
  btn.disabled = true;
  btn.innerHTML = '<span class="btn-icon">‚è≥</span><span class="btn-text">Envoi...</span>';
  
  const taches = taskRatings;
  const emotions = {
    emotion1: selectedEmotions[0] ? selectedEmotions[0].emoji : '',
    emotion2: selectedEmotions[1] ? selectedEmotions[1].emoji : '',
    emotion3: selectedEmotions[2] ? selectedEmotions[2].emoji : '',
    source1: selectedEmotions[0] ? (selectedSourcesByEmotion[selectedEmotions[0].emoji]?.emoji || '') : '',
    source2: selectedEmotions[1] ? (selectedSourcesByEmotion[selectedEmotions[1].emoji]?.emoji || '') : '',
    source3: selectedEmotions[2] ? (selectedSourcesByEmotion[selectedEmotions[2].emoji]?.emoji || '') : '',
    gestion: gestionScore
  };
  
  google.script.run
    .withSuccessHandler(onEvaluationDone)
    .withFailureHandler(handleError)
    .submitEvaluation(currentUser, taches, emotions, selectedHumeur, '');
}

function onEvaluationDone(result) {
  const btn = document.getElementById('btn-submit');
  btn.innerHTML = '<span class="btn-icon">üåü</span><span class="btn-text">Gagner mes √©toiles !</span>';
  
  if (result.success) {
    showSuccessModal(result);
  } else {
    showToast(result.message, 'error');
    btn.disabled = false;
  }
}

function showSuccessModal(result) {
  const modal = document.getElementById('success-modal');
  
  document.getElementById('success-title').textContent = 
    result.stars >= 4 ? 'BRAVO !' : result.stars >= 2 ? 'Bien jou√© !' : 'Continue !';
  document.getElementById('success-message').textContent = result.message;
  document.getElementById('success-points').textContent = result.totalJour;
  const successMax = document.getElementById('success-max');
  if (successMax) {
    successMax.textContent = `/ ${MAX_POINTS} √©toiles`;
  }
  
  const starsDisplay = document.getElementById('success-stars-display');
  starsDisplay.textContent = '‚≠ê'.repeat(result.stars) + '‚òÜ'.repeat(5 - result.stars);
  
  const badgesContainer = document.getElementById('success-badges');
  if (result.newBadges && result.newBadges.length > 0) {
    badgesContainer.innerHTML = '<p style="margin-bottom:10px;font-weight:700;">üéâ Nouveau troph√©e !</p>' +
      result.newBadges.map(b => `
        <div class="new-badge">
          <span>${b.emoji}</span>
          <span>${b.nom}</span>
        </div>
      `).join('');
  } else {
    badgesContainer.innerHTML = '';
  }
  
  modal.classList.add('active');
  createConfetti();
}

function closeModal() {
  document.getElementById('success-modal').classList.remove('active');
  google.script.run
    .withSuccessHandler(onUserLoaded)
    .getPersonneData(currentUser);
}

function createConfetti() {
  const container = document.getElementById('confetti-container');
  container.innerHTML = '';
  const colors = ['#FF6B9D', '#C56CF0', '#54A0FF', '#1DD1A1', '#FECA57', '#FF9F43'];
  
  for (let i = 0; i < 60; i++) {
    const confetti = document.createElement('div');
    confetti.className = 'confetti';
    confetti.style.left = Math.random() * 100 + '%';
    confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
    confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
    confetti.style.animation = `confettiFall ${2 + Math.random() * 2}s ease-out forwards`;
    confetti.style.animationDelay = Math.random() * 0.5 + 's';
    container.appendChild(confetti);
  }
}

// ==================================================
// PAGE STATS
// ==================================================
function loadStatsPage() {
  if (!userData) return;
  
  document.getElementById('stats-week-points').textContent = userData.weekPoints;
  const maxWeek = MAX_POINTS * 7 || 1;
  const weekFill = Math.max(0, Math.min(100, Math.round((userData.weekPoints / maxWeek) * 100)));
  document.getElementById('stats-week-fill').style.width = weekFill + '%';
  document.getElementById('stats-streak').textContent = userData.streak;
  
  const daysContainer = document.getElementById('stats-days');
  const jours = ['L', 'M', 'M', 'J', 'V', 'S', 'D'];
  
  daysContainer.innerHTML = userData.dailyScores.map((score, i) => {
    let classe = '';
    if (score !== null) {
      if (score >= Math.round(MAX_POINTS * 0.85)) classe = 'perfect';
      else if (score >= Math.round(MAX_POINTS * 0.6)) classe = 'good';
      else classe = 'low';
    }
    return `
      <div class="day-cell ${classe}">
        <div class="day-letter">${jours[i]}</div>
        <div class="day-score">${score !== null ? score : '-'}</div>
      </div>
    `;
  }).join('');
  
  // Historique √©motions
  const emotionsContainer = document.getElementById('emotions-history-list');
  if (userData.recentEmotions && userData.recentEmotions.length > 0) {
    emotionsContainer.innerHTML = userData.recentEmotions.map(e => {
      let gestionClass = 'gestion-ok';
      if (e.gestion >= 2) gestionClass = 'gestion-good';
      else if (e.gestion <= 0) gestionClass = 'gestion-bad';
      const emotionList = [e.emotion1, e.emotion2, e.emotion3].filter(Boolean).join(' ');
      
      return `
        <div class="emotion-history-item">
          <div class="emotion-history-date">${e.date}</div>
          <div class="emotion-history-emotions">${emotionList}</div>
          <div class="emotion-history-gestion ${gestionClass}">${e.gestion}/2</div>
        </div>
      `;
    }).join('');
  } else {
    emotionsContainer.innerHTML = '<p style="text-align:center;color:#888;">Pas encore d\'historique</p>';
  }
}

// ==================================================
// PAGE FAMILLE
// ==================================================
function loadFamilyPage() {
  google.script.run
    .withSuccessHandler(displayFamily)
    .getFamilyData();
}

function displayFamily(family) {
  const container = document.getElementById('family-list');
  container.innerHTML = family.map((f, i) => `
    <div class="family-card" style="border-color: ${f.couleur}">
      <div class="family-rank">${i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : '‚≠ê'}</div>
      <div class="family-avatar">${f.avatar}</div>
      <div class="family-info">
        <div class="family-name">${f.nom}</div>
        <div class="family-streak">üî• ${f.streak} jours ‚Ä¢ üèÜ ${f.badgeCount} troph√©es</div>
      </div>
      <div class="family-pts">${f.weekPoints}</div>
      <div class="family-status">${f.evaluatedToday ? '‚úÖ' : '‚è≥'}</div>
    </div>
  `).join('');
}

// ==================================================
// PAGE R√âCOMPENSES
// ==================================================
function loadRewardsPage() {
  if (!userData) return;
  
  document.getElementById('rewards-total').textContent = userData.weekPoints;
  
  const container = document.getElementById('rewards-list');
  container.innerHTML = userData.rewards.map(r => `
    <div class="reward-card ${r.disponible ? 'available' : 'locked'}">
      <div class="reward-emoji">${r.emoji}</div>
      <div class="reward-name">${r.nom}</div>
      <div class="reward-cost">${r.cout} ‚≠ê</div>
      ${r.disponible 
        ? `<button class="btn-reward" onclick="claimReward('${r.id}', '${r.nom}')">Je veux ! üéâ</button>`
        : `<div class="reward-locked">üîí Encore ${r.cout - userData.weekPoints} √©toiles</div>`
      }
    </div>
  `).join('');
}

function claimReward(rewardId, rewardName) {
  if (!confirm(`Tu veux vraiment "${rewardName}" ? üéÅ`)) return;
  
  showToast('Demande en cours...', '');
  
  google.script.run
    .withSuccessHandler(result => {
      showToast(result.message, result.success ? 'success' : 'error');
    })
    .withFailureHandler(handleError)
    .claimReward(currentUser, rewardId);
}

// ==================================================
// PAGE BADGES
// ==================================================
function loadBadgesPage() {
  if (!userData) return;
  
  document.getElementById('badges-num').textContent = userData.badges.length;
  
  const container = document.getElementById('badges-list');
  
  if (userData.badges.length === 0) {
    container.innerHTML = `
      <div class="empty-badges">
        <div class="empty-badges-icon">üéØ</div>
        <p>Continue comme √ßa pour gagner<br>ton premier troph√©e !</p>
      </div>
    `;
    return;
  }
  
  container.innerHTML = userData.badges.map(b => `
    <div class="badge-card obtained">
      <div class="badge-emoji">${b.emoji}</div>
      <div class="badge-name">${b.nom}</div>
    </div>
  `).join('');
}

// ==================================================
// UTILITAIRES
// ==================================================
function showToast(message, type) {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.className = 'toast show ' + type;
}

function hideToast() {
  document.getElementById('toast').classList.remove('show');
}

function handleError(error) {
  console.error(error);
  showToast('Oups ! R√©essaie üòï', 'error');
  
  const btn = document.getElementById('btn-submit');
  if (btn) {
    btn.disabled = false;
    btn.innerHTML = '<span class="btn-icon">üåü</span><span class="btn-text">Gagner mes √©toiles !</span>';
  }
}
</script>
