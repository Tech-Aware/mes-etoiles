<script>
// ==================================================
// MES ETOILES - SCRIPTS v5
// Version simplifiee et optimisee
// ==================================================

let currentUser = null;
let userData = null;
let taskDefinitions = [];
let activeTasks = [];

// Configuration des scores (alignee sur le backend)
const SCORES = {
  TASK_MIN: -1,
  TASK_MAX: 3,
  TASK_ALLOWED: [-1, 0, 1, 2, 3],
  // Conversion etoiles ‚Üí points reels
  // 0 etoiles=-1pt, 1 etoile=0pt, 2 etoiles=1pt, 3 etoiles=2pts
  TASK_TO_POINTS: { '-1': -1, '0': -1, '1': 0, '2': 1, '3': 2 },
  TASK_POINTS_MAX: 2,  // 3 etoiles = 2 points
  TASK_POINTS_MIN: -1, // 0 etoiles = -1 point
  GESTION_MIN: -1,
  GESTION_MAX: 1,
  GESTION_ALLOWED: [-1, 0, 1]
};

// Sources d'emotions (chargees dynamiquement depuis Google Sheets)
let EMOTION_SOURCES = [
  { emoji: 'üè†', name: 'Maison' },
  { emoji: 'üè´', name: 'Ecole' },
  { emoji: 'üë´', name: 'Copains' },
  { emoji: 'üë≠', name: 'Soeur' },
  { emoji: 'üë®‚Äçüë©‚Äçüëß', name: 'Parents' },
  { emoji: '‚öΩ', name: 'Activite' }
]; // Valeurs par defaut, seront remplacees au chargement

// Etat du formulaire
let taskRatings = {};
let selectedEmotions = [];
let selectedSourcesByEmotion = {};
let gestionScore = null;
let selectedHumeur = null;

// ==================================================
// INITIALISATION
// ==================================================
document.addEventListener('DOMContentLoaded', function() {
  loadSourcesEmotions(); // Charger les sources depuis Google Sheets
  loadPersonnes();
  resetForm();
});

function resetForm() {
  taskRatings = {};
  activeTasks.forEach(taskId => {
    taskRatings[taskId] = null;
  });
  selectedEmotions = [];
  selectedSourcesByEmotion = {};
  gestionScore = null;
  selectedHumeur = null;
}

// ==================================================
// SOURCES D'EMOTIONS
// ==================================================
function loadSourcesEmotions() {
  google.script.run
    .withSuccessHandler(function(sources) {
      if (sources && sources.length > 0) {
        EMOTION_SOURCES = sources;
        console.log('Sources d\'emotions chargees:', EMOTION_SOURCES);
      }
    })
    .withFailureHandler(function(error) {
      console.error('Erreur lors du chargement des sources:', error);
      // Garde les sources par defaut en cas d'erreur
    })
    .getSourcesEmotions();
}

// ==================================================
// PERSONNES
// ==================================================
function loadPersonnes() {
  google.script.run
    .withSuccessHandler(displayPersonnes)
    .withFailureHandler(handleError)
    .getPersonnes();
}

function displayPersonnes(personnes) {
  const container = document.getElementById('personnes-list');
  container.innerHTML = personnes.map(p => `
    <div class="personne-card" style="border-color: ${p.couleur}" onclick="selectPersonne('${p.nom}')">
      <span class="personne-avatar">${p.avatar}</span>
      <span class="personne-nom">${p.nom}</span>
    </div>
  `).join('');
}

function selectPersonne(nom) {
  currentUser = nom;
  showToast('Chargement...', '');

  google.script.run
    .withSuccessHandler(onUserLoaded)
    .withFailureHandler(handleError)
    .getPersonneData(nom);
}

function onUserLoaded(data) {
  userData = data;

  document.getElementById('header-avatar').textContent = data.avatar;
  document.getElementById('header-name').textContent = data.nom;
  document.getElementById('header-points').textContent = data.totalPoints;

  document.getElementById('screen-home').classList.remove('active');
  document.getElementById('screen-main').classList.add('active');

  if (data.evaluatedToday) {
    document.getElementById('eval-form').style.display = 'none';
    document.getElementById('already-done').style.display = 'block';
  } else {
    document.getElementById('eval-form').style.display = 'block';
    document.getElementById('already-done').style.display = 'none';
    loadTaskAssignments(currentUser);
  }

  loadStatsPage();
  loadFamilyPage();
  loadRewardsPage();
  loadBadgesPage();

  hideToast();
}

// ==================================================
// TACHES
// ==================================================
function loadTaskAssignments(personne) {
  google.script.run
    .withSuccessHandler(response => {
      taskDefinitions = response?.tasks ?? [];
      activeTasks = response?.taskIds ?? [];

      renderTaskCards(taskDefinitions);
      applyTaskVisibility();
      resetForm();
      resetFormUI();
    })
    .withFailureHandler(error => {
      console.error('[loadTaskAssignments] Erreur:', error);
      handleError(error);
    })
    .getTachesPourPersonne(personne);
}

function normalizeCategorie(value) {
  if (!value) return 'autres';
  const n = value.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase();
  if (n.includes('corvee') || n.includes('travaux')) return 'corvees';
  if (n.includes('rituel')) return 'rituels';
  if (n.includes('comportement')) return 'comportement';
  return 'autres';
}

function getCategoryContainer(categoryKey) {
  let container = document.querySelector(`.tasks-list[data-category="${categoryKey}"]`);
  if (!container) {
    container = document.querySelector('.tasks-list[data-category="autres"]');
  }
  if (!container) {
    container = document.querySelector('.tasks-list[data-category="comportement"]');
  }
  return container;
}

function renderTaskCards(tasks) {
  // Nettoyer les conteneurs existants
  document.querySelectorAll('.tasks-list[data-category]').forEach(container => {
    container.innerHTML = '';
  });

  if (!Array.isArray(tasks) || tasks.length === 0) return;

  // Trier par ordre
  const sortedTasks = [...tasks].sort((a, b) => (a.ordre || 999) - (b.ordre || 999));

  sortedTasks.forEach(task => {
    if (!task?.id) return;

    const categoryKey = normalizeCategorie(task.categorie);
    const container = getCategoryContainer(categoryKey);
    if (!container) return;

    const card = document.createElement('div');
    card.className = 'task-card';
    card.dataset.task = task.id;

    card.innerHTML = `
      <div class="task-visual"><div class="task-emoji">${task.emoji || '‚ú®'}</div></div>
      <div class="task-info">
        <div class="task-name">${task.nom || task.id}</div>
        <div class="task-desc">${task.description || ''}</div>
      </div>
      <div class="rating-scale">
        <button class="scale-btn" data-value="-1" onclick="setTaskRating('${task.id}', -1, this)"><span class="scale-emoji">‚òÜ</span></button>
        <button class="scale-btn" data-value="1" onclick="setTaskRating('${task.id}', 1, this)"><span class="scale-emoji">‚≠ê</span></button>
        <button class="scale-btn" data-value="2" onclick="setTaskRating('${task.id}', 2, this)"><span class="scale-emoji">‚≠ê‚≠ê</span></button>
        <button class="scale-btn" data-value="3" onclick="setTaskRating('${task.id}', 3, this)"><span class="scale-emoji">‚≠ê‚≠ê‚≠ê</span></button>
      </div>
    `;

    container.appendChild(card);
  });
}

function applyTaskVisibility() {
  document.querySelectorAll('.task-card[data-task]').forEach(card => {
    const taskId = card.dataset.task;
    card.style.display = activeTasks.includes(taskId) ? '' : 'none';
  });
}

function resetFormUI() {
  document.querySelectorAll('.scale-btn').forEach(btn => btn.classList.remove('selected'));
  document.querySelectorAll('.emotion-btn').forEach(btn => btn.classList.remove('selected'));
  document.querySelectorAll('.source-btn').forEach(btn => btn.classList.remove('selected'));
  document.querySelectorAll('.gestion-btn').forEach(btn => btn.classList.remove('selected'));
  document.querySelectorAll('.humeur-btn').forEach(btn => btn.classList.remove('selected'));

  document.getElementById('selected-emotions').innerHTML = '';
  document.getElementById('sources-by-emotion').innerHTML = '';
  renderSourcesByEmotion();

  const maxPoints = getMaxPoints();
  document.getElementById('preview-score').textContent = '0';
  document.querySelector('.preview-max').textContent = `/ ${maxPoints}`;
  document.getElementById('preview-fill').style.width = '0%';
  document.getElementById('preview-message').textContent = 'Remplis toutes les cases !';
  document.getElementById('btn-submit').disabled = true;
}

function getMaxPoints() {
  // Max = (nb taches * 2 points) + 1 point gestion
  return activeTasks.length * SCORES.TASK_POINTS_MAX + SCORES.GESTION_MAX;
}

function getMinPoints() {
  // Min = (nb taches * -1 point) + (-1) point gestion
  return activeTasks.length * SCORES.TASK_POINTS_MIN + SCORES.GESTION_MIN;
}

// ==================================================
// NAVIGATION
// ==================================================
function goHome() {
  document.getElementById('screen-main').classList.remove('active');
  document.getElementById('screen-home').classList.add('active');
  currentUser = null;
  userData = null;
  resetForm();

  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  document.querySelector('.nav-btn[data-page="eval"]').classList.add('active');
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById('page-eval').classList.add('active');
}

function showPage(pageName) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));

  document.getElementById('page-' + pageName).classList.add('active');
  document.querySelector(`.nav-btn[data-page="${pageName}"]`).classList.add('active');

  if (pageName === 'family') loadFamilyPage();
  if (pageName === 'stats') loadStatsPage();
}

// ==================================================
// EVALUATION - TACHES
// ==================================================
function setTaskRating(taskId, value, btn) {
  if (!SCORES.TASK_ALLOWED.includes(value)) return;

  taskRatings[taskId] = value;

  const scale = btn.closest('.rating-scale');
  scale.querySelectorAll('.scale-btn').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');

  updatePreview();
  checkCanSubmit();
}

// ==================================================
// EVALUATION - EMOTIONS
// ==================================================
function toggleEmotion(emoji, name, btn) {
  const index = selectedEmotions.findIndex(e => e.emoji === emoji);

  if (index > -1) {
    selectedEmotions.splice(index, 1);
    delete selectedSourcesByEmotion[emoji];
    btn.classList.remove('selected');
  } else {
    if (selectedEmotions.length < 3) {
      selectedEmotions.push({ emoji, name });
      btn.classList.add('selected');
    } else {
      showToast('Maximum 3 emotions !', 'error');
      return;
    }
  }

  updateSelectedEmotionsDisplay();
  renderSourcesByEmotion();
  checkCanSubmit();
}

function updateSelectedEmotionsDisplay() {
  const container = document.getElementById('selected-emotions');

  if (selectedEmotions.length === 0) {
    container.innerHTML = '';
    return;
  }

  container.innerHTML = selectedEmotions.map(e => `
    <div class="selected-emotion-tag">
      <span>${e.emoji}</span>
      <span>${e.name}</span>
    </div>
  `).join('');
}

function renderSourcesByEmotion() {
  const container = document.getElementById('sources-by-emotion');

  if (selectedEmotions.length === 0) {
    container.innerHTML = '<p class="emotion-hint">Commence par choisir tes emotions.</p>';
    return;
  }

  container.innerHTML = selectedEmotions.map(emotion => {
    const selectedSource = selectedSourcesByEmotion[emotion.emoji]?.emoji;
    const buttons = EMOTION_SOURCES.map(source => `
      <button class="source-btn ${selectedSource === source.emoji ? 'selected' : ''}"
              onclick="selectSourceForEmotion('${emotion.emoji}', '${source.emoji}', '${source.name}', this)">
        <span class="source-icon">${source.emoji}</span>
        <span class="source-name">${source.name}</span>
      </button>
    `).join('');

    return `
      <div class="source-emotion-block">
        <div class="source-emotion-title">${emotion.emoji} ${emotion.name}</div>
        <div class="sources-grid">${buttons}</div>
      </div>
    `;
  }).join('');
}

function selectSourceForEmotion(emotionEmoji, sourceEmoji, sourceName, btn) {
  const block = btn.closest('.source-emotion-block');
  if (!block) return;

  block.querySelectorAll('.source-btn').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');

  selectedSourcesByEmotion[emotionEmoji] = { emoji: sourceEmoji, name: sourceName };
  checkCanSubmit();
}

function setGestion(value, btn) {
  if (!SCORES.GESTION_ALLOWED.includes(value)) return;

  document.querySelectorAll('.gestion-btn').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
  gestionScore = value;
  updatePreview();
  checkCanSubmit();
}

function setHumeur(emoji, btn) {
  if (!btn || !emoji) return;

  document.querySelectorAll('.humeur-btn').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
  selectedHumeur = emoji;
  checkCanSubmit();
}

// ==================================================
// PREVIEW & VALIDATION
// ==================================================
function updatePreview() {
  let total = 0;
  let filledTasks = 0;

  // Convertir etoiles en points
  activeTasks.forEach(taskId => {
    if (taskRatings[taskId] !== null && taskRatings[taskId] !== undefined) {
      const stars = taskRatings[taskId];
      const points = SCORES.TASK_TO_POINTS[String(stars)] ?? (stars - 1);
      total += points;
      filledTasks++;
    }
  });

  if (gestionScore !== null) {
    total += gestionScore;
  }

  const maxPoints = getMaxPoints();
  const minPoints = getMinPoints();

  document.getElementById('preview-score').textContent = total;
  document.querySelector('.preview-max').textContent = `/ ${maxPoints}`;

  // Barre de progression normalisee
  const normalized = (total - minPoints) / (maxPoints - minPoints);
  const fillPercent = Math.max(0, Math.min(100, Math.round(normalized * 100)));
  document.getElementById('preview-fill').style.width = fillPercent + '%';

  // Message
  const percent = maxPoints > 0 ? Math.round((total / maxPoints) * 100) : 0;
  let message = '';

  if (filledTasks < activeTasks.length) {
    message = `Encore ${activeTasks.length - filledTasks} cases a remplir !`;
  } else if (gestionScore === null) {
    message = 'N\'oublie pas les emotions !';
  } else if (percent >= 90) {
    message = 'INCROYABLE ! Tu es une STAR !';
  } else if (percent >= 75) {
    message = 'SUPER journee !';
  } else if (percent >= 50) {
    message = 'Bien joue !';
  } else {
    message = 'Tu peux faire mieux demain !';
  }

  document.getElementById('preview-message').textContent = message;
}

function checkCanSubmit() {
  const allTasksFilled = activeTasks.every(t => taskRatings[t] !== null && taskRatings[t] !== undefined);
  const emotionsOk = selectedEmotions.length >= 1;
  const sourceOk = selectedEmotions.every(e => selectedSourcesByEmotion[e.emoji]);
  const gestionOk = gestionScore !== null;
  const humeurOk = selectedHumeur !== null;

  const canSubmit = allTasksFilled && emotionsOk && sourceOk && gestionOk && humeurOk;
  document.getElementById('btn-submit').disabled = !canSubmit;
}

// ==================================================
// SOUMETTRE EVALUATION
// ==================================================
function submitEvaluation() {
  const btn = document.getElementById('btn-submit');
  btn.disabled = true;
  btn.innerHTML = '<span class="btn-icon">‚è≥</span><span class="btn-text">Envoi...</span>';

  const commentaire = (document.getElementById('daily-favorite')?.value || '').trim();

  const emotions = {
    emotion1: selectedEmotions[0]?.emoji || '',
    emotion2: selectedEmotions[1]?.emoji || '',
    emotion3: selectedEmotions[2]?.emoji || '',
    source1: selectedSourcesByEmotion[selectedEmotions[0]?.emoji]?.emoji || '',
    source2: selectedSourcesByEmotion[selectedEmotions[1]?.emoji]?.emoji || '',
    source3: selectedSourcesByEmotion[selectedEmotions[2]?.emoji]?.emoji || '',
    gestion: gestionScore
  };

  google.script.run
    .withSuccessHandler(onEvaluationDone)
    .withFailureHandler(handleError)
    .submitEvaluation(currentUser, taskRatings, emotions, selectedHumeur, commentaire);
}

function onEvaluationDone(result) {
  const btn = document.getElementById('btn-submit');
  btn.innerHTML = '<span class="btn-icon">üåü</span><span class="btn-text">Gagner mes etoiles !</span>';

  if (result.success) {
    showSuccessModal(result);
  } else {
    showToast(result.message, 'error');
    btn.disabled = false;
  }
}

function showSuccessModal(result) {
  const modal = document.getElementById('success-modal');

  document.getElementById('success-title').textContent =
    result.stars >= 4 ? 'BRAVO !' : result.stars >= 2 ? 'Bien joue !' : 'Continue !';
  document.getElementById('success-message').textContent = result.message;
  document.getElementById('success-points').textContent = result.totalJour;
  document.getElementById('success-max').textContent = `/ ${result.maxJour} etoiles`;

  const starsDisplay = document.getElementById('success-stars-display');
  starsDisplay.textContent = '‚≠ê'.repeat(result.stars) + '‚òÜ'.repeat(5 - result.stars);

  const badgesContainer = document.getElementById('success-badges');
  if (result.newBadges && result.newBadges.length > 0) {
    badgesContainer.innerHTML = '<p style="margin-bottom:10px;font-weight:700;">Nouveau trophee !</p>' +
      result.newBadges.map(b => `
        <div class="new-badge">
          <span>${b.emoji}</span>
          <span>${b.nom}</span>
        </div>
      `).join('');
  } else {
    badgesContainer.innerHTML = '';
  }

  modal.classList.add('active');
  createConfetti();
}

function closeModal() {
  document.getElementById('success-modal').classList.remove('active');
  google.script.run
    .withSuccessHandler(onUserLoaded)
    .getPersonneData(currentUser);
}

function createConfetti() {
  const container = document.getElementById('confetti-container');
  container.innerHTML = '';
  const colors = ['#FF6B9D', '#C56CF0', '#54A0FF', '#1DD1A1', '#FECA57', '#FF9F43'];

  for (let i = 0; i < 60; i++) {
    const confetti = document.createElement('div');
    confetti.className = 'confetti';
    confetti.style.left = Math.random() * 100 + '%';
    confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
    confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
    confetti.style.animation = `confettiFall ${2 + Math.random() * 2}s ease-out forwards`;
    confetti.style.animationDelay = Math.random() * 0.5 + 's';
    container.appendChild(confetti);
  }
}

// ==================================================
// PAGE STATS
// ==================================================
function loadStatsPage() {
  if (!userData) return;

  const maxPoints = getMaxPoints();
  const maxWeek = maxPoints * 7;

  document.getElementById('stats-week-points').textContent = userData.weekPoints;
  const weekFill = maxWeek > 0 ? Math.max(0, Math.min(100, Math.round((userData.weekPoints / maxWeek) * 100))) : 0;
  document.getElementById('stats-week-fill').style.width = weekFill + '%';
  document.getElementById('stats-streak').textContent = userData.streak;

  const daysContainer = document.getElementById('stats-days');
  const jours = ['L', 'M', 'M', 'J', 'V', 'S', 'D'];

  daysContainer.innerHTML = userData.dailyScores.map((score, i) => {
    let classe = '';
    if (score !== null) {
      if (score >= Math.round(maxPoints * 0.85)) classe = 'perfect';
      else if (score >= Math.round(maxPoints * 0.6)) classe = 'good';
      else classe = 'low';
    }
    return `
      <div class="day-cell ${classe}">
        <div class="day-letter">${jours[i]}</div>
        <div class="day-score">${score !== null ? score : '-'}</div>
      </div>
    `;
  }).join('');

  // Historique emotions
  const emotionsContainer = document.getElementById('emotions-history-list');
  if (userData.recentEmotions && userData.recentEmotions.length > 0) {
    emotionsContainer.innerHTML = userData.recentEmotions.map(e => {
      let gestionClass = 'gestion-ok';
      if (e.gestion === SCORES.GESTION_MAX) gestionClass = 'gestion-good';
      else if (e.gestion <= 0) gestionClass = 'gestion-bad';
      const emotionList = [e.emotion1, e.emotion2, e.emotion3].filter(Boolean).join(' ');

      return `
        <div class="emotion-history-item">
          <div class="emotion-history-date">${e.date}</div>
          <div class="emotion-history-emotions">${emotionList}</div>
          <div class="emotion-history-gestion ${gestionClass}">${e.gestion}/${SCORES.GESTION_MAX}</div>
        </div>
      `;
    }).join('');
  } else {
    emotionsContainer.innerHTML = '<p style="text-align:center;color:#888;">Pas encore d\'historique</p>';
  }
}

// ==================================================
// PAGE FAMILLE
// ==================================================
function loadFamilyPage() {
  google.script.run
    .withSuccessHandler(displayFamily)
    .getFamilyData();
}

function displayFamily(family) {
  const container = document.getElementById('family-list');
  container.innerHTML = family.map((f, i) => `
    <div class="family-card" style="border-color: ${f.couleur}">
      <div class="family-rank">${i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : '‚≠ê'}</div>
      <div class="family-avatar">${f.avatar}</div>
      <div class="family-info">
        <div class="family-name">${f.nom}</div>
        <div class="family-streak">üî• ${f.streak} jours - üèÜ ${f.badgeCount} trophees</div>
      </div>
      <div class="family-pts">${f.totalPoints}</div>
      <div class="family-status">${f.evaluatedToday ? '‚úÖ' : '‚è≥'}</div>
    </div>
  `).join('');
}

// ==================================================
// PAGE RECOMPENSES
// ==================================================
function loadRewardsPage() {
  if (!userData) return;

  document.getElementById('rewards-total').textContent = userData.totalPoints;

  const container = document.getElementById('rewards-list');
  container.innerHTML = userData.rewards.map(r => `
    <div class="reward-card ${r.disponible ? 'available' : 'locked'}">
      <div class="reward-emoji">${r.emoji}</div>
      <div class="reward-name">${r.nom}</div>
      <div class="reward-cost">${r.cout} ‚≠ê</div>
      ${r.disponible
        ? `<button class="btn-reward" onclick="claimReward('${r.id}', '${r.nom}')">Je veux !</button>`
        : `<div class="reward-locked">üîí Encore ${r.cout - userData.totalPoints} etoiles</div>`
      }
    </div>
  `).join('');
}

function claimReward(rewardId, rewardName) {
  if (!confirm(`Tu veux vraiment "${rewardName}" ?`)) return;

  showToast('Demande en cours...', '');

  google.script.run
    .withSuccessHandler(result => {
      showToast(result.message, result.success ? 'success' : 'error');
      if (result.success) {
        // Recharger les donnees
        google.script.run
          .withSuccessHandler(onUserLoaded)
          .getPersonneData(currentUser);
      }
    })
    .withFailureHandler(handleError)
    .claimReward(currentUser, rewardId);
}

// ==================================================
// PAGE BADGES
// ==================================================
function loadBadgesPage() {
  if (!userData) return;

  document.getElementById('badges-num').textContent = userData.badges.length;

  const container = document.getElementById('badges-list');

  if (userData.badges.length === 0) {
    container.innerHTML = `
      <div class="empty-badges">
        <div class="empty-badges-icon">üéØ</div>
        <p>Continue comme ca pour gagner<br>ton premier trophee !</p>
      </div>
    `;
    return;
  }

  container.innerHTML = userData.badges.map(b => `
    <div class="badge-card obtained">
      <div class="badge-emoji">${b.emoji}</div>
      <div class="badge-name">${b.nom}</div>
    </div>
  `).join('');
}

// ==================================================
// UTILITAIRES
// ==================================================
function showToast(message, type) {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.className = 'toast show ' + type;
}

function hideToast() {
  document.getElementById('toast').classList.remove('show');
}

function handleError(error) {
  console.error(error);
  showToast('Oups ! Reessaie', 'error');

  const btn = document.getElementById('btn-submit');
  if (btn) {
    btn.disabled = false;
    btn.innerHTML = '<span class="btn-icon">üåü</span><span class="btn-text">Gagner mes etoiles !</span>';
  }
}
</script>
